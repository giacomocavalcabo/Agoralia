[build]
builder = "nixpacks"

[deploy]
startCommand = "./railway_start.sh"
healthcheckPath = "/health"
healthcheckTimeout = 300
restartPolicyType = "on_failure"
restartPolicyMaxRetries = 3

[deploy.services]
worker = "./railway_worker_start.sh"

[deploy.environment]
ENV = "production"
BACKEND_BASE_PATH = "/api"
FRONTEND_BASE_URL = "https://app.agoralia.app"
LOG_LEVEL = "INFO"
ENABLE_METRICS = "true"
ENABLE_CRM_SYNC = "true"
ENABLE_WEBHOOKS = "true"
ENABLE_POLLING = "true"

# Variabili critiche per Railway (da impostare manualmente)
# DATABASE_URL = "postgresql+psycopg2://user:pass@host:port/db"
# APP_KMS_KEY = "base64_urlsafe_32_byte_key"
# REDIS_URL = "redis://host:port/db"

[env]
PYTHON_VERSION = "3.11"

# ===================== CONFIGURAZIONE RAILWAY =====================
# 
# 1. SERVICE API:
#    - Start Command: PYTHONPATH=/app + ALEMBIC_CONFIG=backend/alembic.ini
#    - Healthcheck: /health (endpoint esistente)
#    - Port: $PORT (Railway lo imposta automaticamente)
#
# 2. WORKER:
#    - Start Command: ./railway_worker_start.sh (auto-riparante con test DB)
#    - Test connessione DB prima di avviare worker
#    - Nessuna migrazione (solo API le esegue)
#
# 3. VARIABILI D'AMBIENTE OBBLIGATORIE (impostare manualmente su Railway):
#    - DATABASE_URL: postgresql+psycopg2://user:pass@host:port/db
#    - APP_KMS_KEY: chiave simmetrica base64 urlsafe 32+ byte (STESSA per tutti i servizi!)
#    - REDIS_URL: redis://host:port/db (se usi cache/sessioni)
#
# 4. GENERAZIONE APP_KMS_KEY:
#    python generate_app_kms_key.py
#
# 5. TEST POST-DEPLOY:
#    curl -i https://api.agoralia.app/health
#    curl -i https://api.agoralia.app/api/auth/me
#
# 6. RISOLUZIONE PROBLEMA ALEMBIC:
#    - PRIMA: script_location = alembic (cercava /app/alembic)
#    - ORA: script_location = backend/alembic (cerca /app/backend/alembic)
#    - PYTHONPATH=/app permette import backend.* in env.py
#
# 7. RISOLUZIONE PROBLEMA "Table already exists":
#    - PRIMA: alembic upgrade head falliva su tabelle esistenti
#    - ORA: railway_start.sh auto-ripara con alembic stamp head
#    - Lo script verifica alembic_version e timbra automaticamente
#
# 8. RISOLUZIONE PROBLEMA "StringDataRightTruncation":
#    - PRIMA: alembic_version aveva version_num varchar(32) troppo corto
#    - ORA: railway_start.sh crea/allarga colonna a varchar(255)
#    - env.py configurato per usare varchar(255) in futuro
#
# 9. RISOLUZIONE PROBLEMA "psql command not found":
#    - PRIMA: script usava psql che non esiste nel container Railway
#    - ORA: usa Python/SQLAlchemy per operazioni database
#    - Nessuna dipendenza da client PostgreSQL esterni
#
# 10. RISOLUZIONE PROBLEMA "ModuleNotFoundError: No module named 'backend'":
#     - PRIMA: PYTHONPATH=/app/backend causava import backend.* falliti
#     - ORA: forza PYTHONPATH=/app e verifica import prima di Alembic
#     - Hardening in alembic/env.py per robustezza a working dir
#
# 11. RISOLUZIONE PROBLEMA "could not translate host name" (Worker):
#     - PRIMA: worker usava DATABASE_URL con UUID come hostname
#     - ORA: railway_worker_start.sh pulisce variabili ambiente e testa DB
#     - Unset PGHOST/POSTGRES_*/DB_* che possono sporcare la connessione
#     - Validazione URL con make_url e test connessione con pool_pre_ping
