[build]
builder = "nixpacks"

[deploy]
startCommand = "sh -c 'ALEMBIC_CONFIG=backend/alembic.ini alembic upgrade head && PYTHONPATH=/app exec uvicorn backend.main:app --host 0.0.0.0 --port $PORT --workers 1 --loop=asyncio --http=h11'"
healthcheckPath = "/health"
healthcheckTimeout = 300
restartPolicyType = "on_failure"
restartPolicyMaxRetries = 3

[deploy.services]
worker = "sh -c 'PYTHONPATH=/app exec python -m backend.worker'"

[deploy.environment]
ENV = "production"
APP_BASE_URL = "https://api.agoralia.app"
FRONTEND_BASE_URL = "https://app.agoralia.app"
LOG_LEVEL = "INFO"
ENABLE_METRICS = "true"
ENABLE_CRM_SYNC = "true"
ENABLE_WEBHOOKS = "true"
ENABLE_POLLING = "true"

# Variabili critiche per Railway (da impostare manualmente)
# DATABASE_URL = "postgresql+psycopg2://user:pass@host:port/db"
# APP_KMS_KEY = "base64_urlsafe_32_byte_key"
# REDIS_URL = "redis://host:port/db"

[env]
PYTHON_VERSION = "3.11"

# ===================== CONFIGURAZIONE RAILWAY =====================
# 
# 1. SERVICE API:
#    - Start Command: gi√† configurato con ALEMBIC_CONFIG e PYTHONPATH
#    - Healthcheck: /health (endpoint esistente)
#    - Port: $PORT (Railway lo imposta automaticamente)
#
# 2. WORKER:
#    - Start Command: python -m backend.worker (no HTTP, no healthcheck)
#    - PYTHONPATH=/app per import corretto
#
# 3. VARIABILI D'AMBIENTE OBBLIGATORIE (impostare manualmente su Railway):
#    - DATABASE_URL: postgresql+psycopg2://user:pass@host:port/db
#    - APP_KMS_KEY: chiave simmetrica base64 urlsafe 32+ byte
#    - REDIS_URL: redis://host:port/db (se usi cache/sessioni)
#
# 4. GENERAZIONE APP_KMS_KEY:
#    python -c "import secrets,base64;print(base64.urlsafe_b64encode(secrets.token_bytes(32)).decode())"
#
# 5. TEST POST-DEPLOY:
#    curl -i https://api.agoralia.app/health
#    curl -i https://api.agoralia.app/api/auth/me
