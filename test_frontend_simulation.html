<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Frontend OAuth Flow</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .log { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 3px; font-family: monospace; }
    </style>
</head>
<body>
    <h1>üß™ Test Frontend OAuth Flow Simulation</h1>
    
    <div class="test-section info">
        <h3>Test 1: URL Parameter Parsing</h3>
        <p>Simula il comportamento del frontend con diversi parametri URL</p>
        <button onclick="testUrlParsing()">Test URL Parsing</button>
        <div id="url-log" class="log"></div>
    </div>
    
    <div class="test-section info">
        <h3>Test 2: OAuth Callback Simulation</h3>
        <p>Simula il callback OAuth con ?hubspot=connected</p>
        <button onclick="simulateOAuthCallback()">Simula OAuth Callback</button>
        <div id="callback-log" class="log"></div>
    </div>
    
    <div class="test-section info">
        <h3>Test 3: Error Handling</h3>
        <p>Simula il callback OAuth con ?hubspot=expired</p>
        <button onclick="simulateOAuthError()">Simula OAuth Error</button>
        <div id="error-log" class="log"></div>
    </div>
    
    <div class="test-section info">
        <h3>Test 4: URL Cleanup</h3>
        <p>Testa la pulizia dell'URL dopo il callback</p>
        <button onclick="testUrlCleanup()">Test URL Cleanup</button>
        <div id="cleanup-log" class="log"></div>
    </div>

    <script>
        let didConsumeHubspotFlag = false;
        
        function log(elementId, message) {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            element.innerHTML += `[${timestamp}] ${message}\n`;
        }
        
        function testUrlParsing() {
            const logId = 'url-log';
            log(logId, 'üß™ Testing URL Parameter Parsing...');
            
            // Test diversi scenari URL
            const testUrls = [
                'https://app.agoralia.app/settings/integrations',
                'https://app.agoralia.app/settings/integrations?hubspot=connected',
                'https://app.agoralia.app/settings/integrations?hubspot=expired',
                'https://app.agoralia.app/settings/integrations?other=param&hubspot=connected',
                'https://app.agoralia.app/settings/integrations?hubspot=connected&other=param'
            ];
            
            testUrls.forEach((url, index) => {
                const urlObj = new URL(url);
                const flag = urlObj.searchParams.get('hubspot');
                log(logId, `Test ${index + 1}: ${url}`);
                log(logId, `  ‚Üí hubspot parameter: ${flag || 'null'}`);
                
                if (flag === 'connected') {
                    log(logId, '  ‚úÖ Would trigger OAuth success flow');
                } else if (flag === 'expired') {
                    log(logId, '  ‚ö†Ô∏è Would trigger OAuth error flow');
                } else {
                    log(logId, '  ‚ÑπÔ∏è No OAuth parameter - normal page load');
                }
            });
            
            log(logId, '‚úÖ URL parsing test completed');
        }
        
        function simulateOAuthCallback() {
            const logId = 'callback-log';
            log(logId, 'üß™ Simulating OAuth Callback with ?hubspot=connected...');
            
            // Simula il comportamento del frontend
            const search = '?hubspot=connected';
            const q = new URLSearchParams(search);
            const flag = q.get('hubspot');
            
            log(logId, `URL Search: ${search}`);
            log(logId, `Parsed flag: ${flag}`);
            
            if (didConsumeHubspotFlag) {
                log(logId, '‚ö†Ô∏è Flag already consumed - would be ignored');
                return;
            }
            
            if (!flag) {
                log(logId, '‚ÑπÔ∏è No flag present - normal page load');
                return;
            }
            
            didConsumeHubspotFlag = true;
            log(logId, '‚úÖ Flag consumed - preventing re-triggering');
            
            if (flag === 'connected') {
                log(logId, 'üéâ OAuth Success Flow:');
                log(logId, '  1. Show toast: "HubSpot Connected"');
                log(logId, '  2. Force refetch integration status');
                log(logId, '  3. Clean URL (remove ?hubspot=connected)');
                log(logId, '  4. Update UI to show "Connected" status');
            }
            
            log(logId, '‚úÖ OAuth callback simulation completed');
        }
        
        function simulateOAuthError() {
            const logId = 'error-log';
            log(logId, 'üß™ Simulating OAuth Error with ?hubspot=expired...');
            
            const search = '?hubspot=expired';
            const q = new URLSearchParams(search);
            const flag = q.get('hubspot');
            
            log(logId, `URL Search: ${search}`);
            log(logId, `Parsed flag: ${flag}`);
            
            if (flag === 'expired') {
                log(logId, '‚ùå OAuth Error Flow:');
                log(logId, '  1. Show toast: "Authorization Expired"');
                log(logId, '  2. Clean URL (remove ?hubspot=expired)');
                log(logId, '  3. Show "Disconnected" status');
                log(logId, '  4. User can retry connection');
            }
            
            log(logId, '‚úÖ OAuth error simulation completed');
        }
        
        function testUrlCleanup() {
            const logId = 'cleanup-log';
            log(logId, 'üß™ Testing URL Cleanup...');
            
            // Simula diversi scenari di cleanup
            const testCases = [
                {
                    original: 'https://app.agoralia.app/settings/integrations?hubspot=connected',
                    expected: 'https://app.agoralia.app/settings/integrations'
                },
                {
                    original: 'https://app.agoralia.app/settings/integrations?hubspot=expired',
                    expected: 'https://app.agoralia.app/settings/integrations'
                },
                {
                    original: 'https://app.agoralia.app/settings/integrations?other=param&hubspot=connected',
                    expected: 'https://app.agoralia.app/settings/integrations?other=param'
                }
            ];
            
            testCases.forEach((testCase, index) => {
                const url = new URL(testCase.original);
                url.searchParams.delete('hubspot');
                const cleaned = url.toString();
                
                log(logId, `Test ${index + 1}:`);
                log(logId, `  Original: ${testCase.original}`);
                log(logId, `  Cleaned:  ${cleaned}`);
                log(logId, `  Expected: ${testCase.expected}`);
                log(logId, `  Match: ${cleaned === testCase.expected ? '‚úÖ' : '‚ùå'}`);
            });
            
            log(logId, '‚úÖ URL cleanup test completed');
        }
        
        // Auto-run basic tests on page load
        window.onload = function() {
            log('url-log', 'üöÄ Frontend OAuth Flow Test Suite Loaded');
            log('url-log', 'Click the buttons above to run individual tests');
        };
    </script>
</body>
</html>
